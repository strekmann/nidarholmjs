cache:
  paths:
    - node_modules/
    - .yarn

#default:
#  before_script:
#    - apt install build-essential

stages:
  - build_code
  - build_image

build_code:
  image: node:14-alpine
  stage: build_code
  script:
    - apk add --no-cache make g++ gcc python
    - yarn install --frozen-lockfile --production
    - cp -r node_modules node_modules_production
    - yarn install --frozen-lockfile
    - yarn build-project
    - mv node_modules_production dist/node_modules
  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - dist/
  only:
    - pushes
  interruptible: true

build_image:
  image: fedora
  stage: build_image
  needs:
    - job: build_code
      artifacts: true
  script:
    - dnf install buildah podman -y
    - set -x
    - export STORAGE_DRIVER=vfs
    - img=$(buildah from node:14-alpine)
    - buildah config --port 3000 "$img"
    - buildah config --user node "$img"
    - buildah config --workingdir /home/node "$img"
    - buildah copy --chown=node:node "$img" ./dist dist
    - buildah copy --chown=node:node "$img" $CONFIG dist/config
    - buildah config --workingdir /home/node/dist "$img"
    - buildah config --entrypoint '["node", "server/index.js"]' "$img"
    - buildah commit "$img" "nidarholm"
    - buildah rm "$img"
    - podman push --creds $N_CREDS localhost/nidarholm docker://registry.gitlab.com/strekmann/nidarholmjs:latest
  #  - podman save localhost/test -o nidarholm-$CI_COMMIT_SHORT_SHA.tar
  #  - gzip nidarholm-$CI_COMMIT_SHORT_SHA.tar
  #artifacts:
  #  paths:
  #    - nidarholm.tar.gz
  only:
    - pushes

deploy_image:
  image: debian
  stage: deploy_image
  needs:
    - job: build_image
      artifacts: true
  script:
    - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    #  - scp -P 2022 nidarholm-$CI_COMMIT_SHORT_SHA.tar.gz leigh.strekmann.no:~
    #  - ssh -p 2022 leigh.strekmann.no gunzip nidarholm-$CI_COMMIT_SHORT_SHA.tar.gz
    #  - ssh -p 2022 leigh.strekmann.no podman load -i nidarholm-$CI_COMMIT_SHORT_SHA.tar nidarholm
    - ssh -p 2022 leigh.strekmann.no podman pull --creds $N_CREDS docker://registry.gitlab.com/strekmann/nidarholmjs:latest
    - ssh -p 2022 leigh.strekmann.no systemctl restart nidarholm-web
