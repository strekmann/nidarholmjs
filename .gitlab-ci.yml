cache:
  key: ${CI_JOB_NAME}
  paths:
    - node_modules/
    - .yarn

stages:
  - build
  - deploy

build_code:
  image: node:14-alpine
  stage: build
  script:
    - time apk add --no-cache make g++ gcc python imagemagick
    - yarn install --frozen-lockfile --production
    - cp -r node_modules node_modules_production
    - yarn install --frozen-lockfile
    - yarn build-project
    - mv node_modules_production dist/node_modules
  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - dist/
  only:
    refs:
      - pushes
    changes:
      - "src/**/*"
  interruptible: true

build_image:
  image: fedora
  stage: build
  needs:
    - job: build_code
      artifacts: true
  script:
    - time dnf install -y buildah podman
    - set -x
    - export STORAGE_DRIVER=vfs
    - img=$(buildah from node:14-alpine)
    - buildah config --port 3000 "$img"
    - buildah config --user node "$img"
    - buildah config --workingdir /home/node "$img"
    - buildah copy --chown=node:node "$img" ./dist dist
    - buildah copy --chown=node:node "$img" ./config dist/config
    - buildah copy --chown=node:node "$img" $N_PRODUCTION_CONFIG_JS dist/config/production.js
    - buildah config --workingdir /home/node/dist "$img"
    - buildah config --entrypoint '["node", "server/index.js"]' "$img"
    - buildah commit "$img" "nidarholm"
    - buildah rm "$img"
    - podman push --creds $N_WRITE_REGISTRY localhost/nidarholm docker://registry.gitlab.com/strekmann/nidarholmjs:latest
  only:
    refs:
      - pushes
    changes:
      - "src/**/*"

build_mailman_sync:
  image: rust:stretch
  stage: build
  script:
    - apt update
    - apt install -y pkg-config
    - cargo build --release
  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - target/release
  only:
    refs:
      - pushes
    changes:
      - "mailman-sync/**/*"

deploy_image:
  image: debian
  stage: deploy
  needs:
    - job: build_image
  script:
    - "which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - ssh -p 2022 leigh.strekmann.no podman pull --creds $N_READ_REGISTRY docker://registry.gitlab.com/strekmann/nidarholmjs:latest
    - ssh -p 2022 leigh.strekmann.no systemctl restart nidarholm-web.service
  only:
    refs:
      - pushes
    changes:
      - "src/**/*"
