variables:
  DOCKER_DRIVER: "overlay2"
  DOCKER_BUILDKIT: 1
  IMAGE: "${CI_REGISTRY_IMAGE}/nidarholm-web:${CI_COMMIT_SHORT_SHA}"
  LATEST_IMAGE: "${CI_REGISTRY_IMAGE}/nidarholm-web:latest"


stages:
  - "build"

services:
  - "docker:dind"

container:
  stage: "build"
  image: "docker"
  before_script:
    - "docker login ${CI_REGISTRY} -u gitlab-ci-registry -p ${REGISTRY_WRITE_TOKEN}"
  script:
    - "docker build --cache-from ${LATEST_IMAGE} --tag ${IMAGE} --tag ${LATEST_IMAGE} --build-arg BUILDKIT_INLINE_CACHE=1 ."
  after_script:
    - "docker push ${IMAGE}"
    - "docker push ${LATEST_IMAGE}"

build_mailman_sync:
  image: rust:stretch
  stage: build
  script:
    - apt update
    - apt install -y pkg-config
    - cargo build --release --locked
  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - target/release
  only:
    refs:
      - pushes
    changes:
      - "mailman-sync/**/*"
