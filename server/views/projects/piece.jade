extends ../layouts/main.jade

block content
  .row
    .columns
      section#piece
        h1= piece.title

  script#template(type="text/ractive")
    .row
      .columns
        h1 {{.piece.title}}
          | {{#.piece.subtitle}}
          small {{.piece.subtitle}}
          | {{/.piece.subtitle}}
          .right
            small
              | {{#.piece.composers.length}}
              span {{.piece.composers.join(", ")}}
              | {{/.piece.composers.length}}
              | {{#.piece.arrangers.length}}
              span ({{.piece.arrangers.join(", ")}})
              | {{/.piece.arrangers.length}}

        .row
          .columns.medium-6
            p
              | {{#.piece.publisher}}
              span {{.piece.publisher}},
              | {{/.piece.publisher}}
              | {{#.piece.published}}
              span {{.piece.published}},
              | {{/.piece.published}}
              | {{#.piece.genre}}
              span {{.piece.genre}},
              | {{/.piece.genre}}
              | {{#.piece.band_setup}}
              span {{.piece.band_setup}}
              | {{/.piece.band_setup}}

          .columns.medium-6
            .right
              p
                | {{#.piece.archive_number}}
                b {{.piece.archive_number}}:
                | {{/.piece.archive_number}}
                | {{#.piece.maintenance_status}}
                span {{.piece.maintenance_status}},
                | {{/.piece.maintenance_status}}
                | {{#.piece.acquired}}
                span {{.piece.acquired}}
                | {{/.piece.acquired}}


        | {{#if user_scores.length}}
        h2 Last ned noter
        | {{# user_scores}}
        .row
          .columns.small-5.medium-3.large-2
            a.button(href="{{.path}}") Last ned
          .columns.small-7.medium-9.large-10
            h3
              a(href="/files/{{._id}}") {{.filename}}
          | {{/ user_scores}}
        | {{/if user_scores.length}}

        if is_musicscoreadmin
          h2 Last opp noter
          | {{#groups}}
          h3 {{.name}}
          form.sigdrop.drop.dropzone(id="drop-{{._id}}" action="/music/{{piece._id}}/scores")
            input(name="group" type="hidden" value="{{._id}}")
            .fallback
              input(name="file" type="file" multiple)
          //
            form.dropzone.drop(id="drop-{{._id}}" action="/music/{{piece._id}}/scores")
              input(name="group" type="hidden" value="{{._id}}")
              .fallback
                input(name="file" type="file" multiple)
          | {{/groups}}

          h2 Last ned noter
          | {{#groups}}
          h3 {{.name}}
          | {{#.scores}}
          .row
            .columns.small-5.medium-3.large-2
              a.button(href="{{.path}}") Last ned
            .columns.small-7.medium-9.large-10
              h3
                a(href="/files/{{._id}}") {{.filename}}
          | {{/.scores}}
          | {{/groups}}


        if is_musicscoreadmin
          | {{#if expandedDescription}}
          h2 Endre verksbeskrivelse
          form(on-submit="saveDescription")
            textarea(name="description" type="textarea" value="{{piece.description}}")
            button Lagre
          | {{else}}
          button.tiny.right(on-click="toggleDescription")
            i.fa.fa-fw.fa-edit
          | {{/if expandedDescription}}

        h2 Verkbeskrivelse
        | {{#if piece.description}}
        | {{{marked(piece.description)}}}
        | {{else}}
        p
          em Ingen
        | {{/if}}

        if is_musicscoreadmin
          | {{#if expandedDescriptionComposer}}
          h2 Endre tekst fra komponist
          form(on-submit="saveDescriptionComposer")
            textarea(name="description_composer" type="textarea" value="{{piece.description_composer}}")
            button Lagre
          | {{else}}
          button.tiny.right(on-click="toggleDescriptionComposer")
            i.fa.fa-fw.fa-edit
          | {{/if expandedDescriptionComposer}}

        h2 Tekst fra komponist
        | {{#if piece.description_composer}}
        | {{{marked(piece.description_composer)}}}
        | {{else}}
        p
          em Ingen
        | {{/if}}

        if is_musicscoreadmin
          | {{#if expandedDescriptionArranger}}
          h2 Endre tekst fra arrangør
          form(on-submit="saveDescriptionArranger")
            textarea(name="description_arranger" type="textarea" value="{{piece.description_arranger}}")
            button Lagre
          | {{else}}
          button.tiny.right(on-click="toggleDescriptionArranger")
            i.fa.fa-fw.fa-edit
          | {{/if expandedDescriptionArranger}}

        h2 Tekst fra arrangør
        | {{#if piece.description_arranger}}
        | {{{marked(piece.description_arranger)}}}
        | {{else}}
        p
          em Ingen
        | {{/if}}

        if is_musicscoreadmin
          | {{#if expandedDescriptionPublisher}}
          h2 Endre tekst fra forlag/utgiver
          form(on-submit="saveDescriptionPublisher")
            textarea(name="description_publisher" type="textarea" value="{{piece.description_publisher}}")
            button Lagre
          | {{else}}
          button.tiny.right(on-click="toggleDescriptionPublisher")
            i.fa.fa-fw.fa-edit
          | {{/if expandedDescriptionPublisher}}

        h2 Tekst fra forlag/utgiver
        | {{#if piece.description_publisher}}
        | {{{marked(piece.description_publisher)}}}
        | {{else}}
        p
          em Ingen
        | {{/if}}


block javascript
  script
    | require('s7n').projects.piece(
    != JSON.stringify(piece)
    | ,
    != JSON.stringify(groups)
    | ,
    != JSON.stringify(user_scores)
    | );
