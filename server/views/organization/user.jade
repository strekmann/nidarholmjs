extends ../layouts/main

block content
  #user
    .row
      .medium-3.columns.hide-for-small-only
          a(href="#" on-click="changeProfilePicture")
            if user.profile_picture_path
              img#picture(src=user.profile_picture_path)
            else
              img#picture(src="/img/user.svg")

      .medium-9.columns
        if active_user && active_user.username == user.username
          .right
            a(href="/users/"+user.username+"/edit")
              i.fa.fa-edit(title="Rediger personalia")

        h1= user.name 
          small= user.instrument

        p= user.email
          br
          = user.phone

        p
          = user.address
          br
          = user.postcode 
          = user.city
          br
          = user.country

        p= user.nmf_id

        if user.is_active
          | Aktiv bruker
        if user.is_admin
          | Admin

        if is_admin
          // TODO: Set better permission checks
          p= user.born
          p= user.joined
          p= user.reskontro
          = user.membership_history

        p#username(data-username=user.username)= user.username

      .medium-3.columns
        if active_user && user.id==active_user.id || is_admin
          a.button.tiny(href="/users/" + user.username + "/edit") Rediger brukerdata
          a.button.tiny(href="/logout") Logg ut

        h2 Grupper
          if !user.groups || user.groups.length === 0
            p Ingen grupper. Legg personen til i grupper ved å trykke knappen under.
        #groups
          ul
            if user.groups
              for group in user.groups
                if group
                  li.group(data-id=group.id)
                    a(href="/groups/" + group._id)= group.name
                    a.removegroup(href="#")
                      i.fa.fa-times
                else
                  = group


          #addgroup
            //button.new_group.small
              i.fa.fa-plus
            form(on-submit="addGroup" method="POST" action="/users/" + user.username + "/groups")
              .row
                .columns
                  h3 Legg til i grupper
              .row
                .columns
                  label(for='group') Finn gruppe
                  select#group
                    for group in groups
                      option(value=group.id)= group.name
              .row
                .columns
                  //button.reset.secondary(type='reset') Avbryt
                  button.tiny Legg til

  script#usertemplate(type="text/ractive")
    #profile-pictures.reveal-modal(data-reveal)
      .row
        | {{#user}}
        .columns
          form#upload(action='/users/{{username}}/pictures')
            | Dra filer hit, eller klikk for å velge

            | {{#uploading_files}}
            .uploading(outro='fade:500')
              strong {{name}}
              .progress
                span.meter(style="width: {{uploading.progress}}%")
            | {{/uploading_files}}

          ul.small-block-grid-4
            | {{#files}}
            li(intro="fade" class="{{ is_active_image(_id) ? 'active' : '' }}")
              a(href="/users/{{username}}/pictures/{{_id}}" on-click="setProfilePicture")
                img.th(src="{{path}}")
            | {{/files}}
        | {{/user}}
      a.close-reveal-modal
        i.fa.fa-times-circle-o

    | {{#user}}
    .row
      .medium-3.columns.hide-for-small-only
        a(href="/users/{{username}}/picture" on-click="changeProfilePicture")
          | {{#profile_picture}}
          img#picture(src="{{profile_picture_path}}")
          | {{/profile_picture}}
          | {{^profile_picture}}
          img#picture(src="/img/user.svg")
          | {{/profile_picture}}

      .medium-9.columns
        .right
          | {{#is_active_user}}
          a(href="/users/{{username}}/edit")
            i.fa.fa-edit(title="Rediger personalia")
          | {{/is_active_user}}

        <h1>{{name}} <small>{{instrument}}</small></h1>

        .show-for-small-only
          a(href="/users/{{username}}/picture" on-click="changeProfilePicture")
            | {{#profile_picture}}
            img#picture(src="{{profile_picture_path}}")
            | {{/profile_picture}}
            | {{^profile_picture}}
            img#picture(src="/img/user.svg")
            | {{/profile_picture}}

        .email
          i.fa.fa-envelope
          | &nbsp;
          a(href="mailto:{{email}}") {{email}}

        | {{#phone}}
        p.phone
          i.fa.fa-phone
          | &nbsp;
          | {{phoneformat(phone)}}
        | {{/phone}}

        .address
          | {{address}}
        .city
          | {{postcode}} {{city}}
        | {{#country!='NO'}}
        .country
          | {{country}}
        | {{/country}}

        if is_admin
          p {{reskontro}}
          | {{membership_history}}

        p Brukernavn <code>{{username}}</code>, passordalgoritme: <code>{{algorithm}}</code>, krypteringsstyrke: <code>{{length(salt)}}</code>
        | {{#is_active}}
        | Aktiv
        | {{/is_active}}
        | {{#is_admin}}
        | Admin
        | {{/is_admin}}

    .row
      .hide-for-small-only
        .medium-3.columns
          hr

          | {{#born}}
          p
            | Bursdag {{bday(born)}}
          | {{/born}}

          | {{#joined}}
          p
            | Startet {{ago(joined)}} og har NMF-nummer {{nmf_id}}
          | {{/joined}}

      .medium-9.columns
        hr

        h2 Grupper
          if !user.groups || user.groups.length === 0
            p Ingen grupper. Legg personen til i grupper ved å trykke knappen under.

        ul
          | {{#groups}}
          li.group
            a(href="/groups/{{_id}}") {{name}}
            a.removegroup(on-click="removeGroup" href="/users/{{../../username}}/groups/{{_id}}")
              i.fa.fa-times
          | {{/groups}}

        #addgroup
          //button.new_group.small
            i.fa.fa-plus
          form(on-submit="addGroup" method="POST" action="/users/{{username}}/groups")
            .row
              .columns
                h3 Legg til i grupper
            .row
              .columns
                label(for='group') Finn gruppe
                select#group
                  for group in groups
                    option(value=group.id)= group.name
            .row
              .columns
                //button.reset.secondary(type='reset') Avbryt
                button.tiny Legg til
    | {{/user}}

block javascript
  script
    | var user = require('s7n').user.userView(
    != JSON.stringify(user)
    if active_user
      | ,
      != JSON.stringify(active_user)
    | );
